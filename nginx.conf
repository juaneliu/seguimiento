# Configuración de Deploy para Oracle Cloud

server {
    listen 80;
    server_name seguimiento.saem.gob.mx;
    
    # Redirect HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name seguimiento.saem.gob.mx;
    
    # SSL Configuration
    ssl_certificate /etc/letsencrypt/live/seguimiento.saem.gob.mx/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/seguimiento.saem.gob.mx/privkey.pem;
    
    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline' https://cdn.amcharts.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https:; font-src 'self' data: https://fonts.gstatic.com; connect-src 'self';" always;
    
    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/javascript;
    
    # Proxy to Next.js with improved configuration
    location / {
        # Health check - retry upstream if down
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
        proxy_next_upstream_tries 3;
        proxy_next_upstream_timeout 30s;
        
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # Increased timeouts to prevent 502 errors
        proxy_connect_timeout 30s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
        proxy_buffering on;
        proxy_buffer_size 128k;
        proxy_buffers 4 256k;
        proxy_busy_buffers_size 256k;
        
        # Additional headers for better compatibility
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        proxy_redirect off;
        
        # Custom error pages for 502 errors
        error_page 502 @fallback;
    }
    
    # Fallback location for 502 errors
    location @fallback {
        return 503 '<!DOCTYPE html>
<html>
<head>
    <title>Servicio Temporalmente No Disponible</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; padding: 50px; }
        .container { max-width: 600px; margin: 0 auto; }
        .error-code { font-size: 72px; color: #e74c3c; margin: 20px 0; }
        .message { font-size: 18px; color: #333; margin: 20px 0; }
        .submessage { color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <div class="error-code">503</div>
        <div class="message">El servicio se está iniciando</div>
        <div class="submessage">Por favor, espere unos momentos y recargue la página.</div>
        <script>
            setTimeout(function(){ location.reload(); }, 5000);
        </script>
    </div>
</body>
</html>';
        add_header Content-Type text/html;
    }
}
